pipeline {
  agent any
  environment {
    set "DASTARDLY_TARGET_URL=https://staging.criticalmention.com/app/#/user/login"
    set "IMAGE_WITH_TAG=public.ecr.aws/portswigger/dastardly:latest"
    set "JUNIT_TEST_RESULTS_FILE=dastardly-report.xml"
  }
  stages {
    stage ("Docker Pull Dastardly from Burp Suite container image") {
      steps {
        docker pull ${IMAGE_WITH_TAG}
      }
    }
    stage ("Docker run Dastardly from Burp Suite Scan") {
      steps {
        cleanWs()

        docker run --rm --user %USERNAME% -v "%WORKSPACE%:%WORKSPACE%:rw" \
        -e DASTARDLY_TARGET_URL=%DASTARDLY_TARGET_URL% \
        -e DASTARDLY_OUTPUT_FILE=%WORKSPACE%\%JUNIT_TEST_RESULTS_FILE% \
        %IMAGE_WITH_TAG%

      }
    }
  }
  post {
    always {
      junit testResults: "${JUNIT_TEST_RESULTS_FILE}", skipPublishingChecks: true
    }
  }
}
